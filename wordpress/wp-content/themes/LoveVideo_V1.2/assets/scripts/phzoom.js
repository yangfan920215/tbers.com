~function(G){var E=G(window),A=G(document),D=G("<div id=ph_lay/>"),F=G("<div id=ph_zoom/>"),B=D.add(F),C=function(J,H,I,K){this.opt=H;this.idx=I;this.all=K;this.len=K.length;this.end=this.len>I+1;this.img=G("img:first",J);this.lnk=J.addClass("phzoom").unbind("click").bind(this.imgFn()).append(this.hov=G("<span class=ph_hover/>").hide())[0];this.cap=G("<div/>",{css:{color:H.capColor},id:"ph_cap",html:G([G("<span/>",{id:"ph_txt",text:this.img[0].title||this.lnk.title||"No title"})[0],G("<span/>",{id:"ph_idx",text:I+1+" / "+this.len})[0]])}).add(this.nav=G("<div/>",{id:"ph_nav",css:{color:H.navColor},html:(I?"<span id=ph_prev>"+H.prevText+"</span>":"")+(this.end?"<span id=ph_next>"+H.nextText+"</span>":"")}));B.click(G.proxy(this,"imgQuit"));window.XMLHttpRequest||J.height(this.img.height())};C.prototype={imgFn:function(){var I=this,H=function(){return I.hov.not(".loading").stop(0,1)};return{mouseover:function(){H().fadeIn()},mouseout:function(){H().fadeOut()},click:function(){I.imgLoad();return false}}},imgPos:function(M,K){var L=this.img,H=E.scrollLeft(),J=E.scrollTop(),I=[E.width(),E.height(),L.width(),L.height(),L.offset().left,L.offset().top];this.opt.limitWidth&&M>I[0]&&(K=K/M*(M=I[0]));return I.concat(M,K,(I[0]-M)/2+H,(I[1]-K)/2+J,(I[0]-I[2])/2+H,(I[1]-I[3])/2+J)},imgLoad:function(){D.fadeTo(this.opt.layDur,this.opt.layOpacity);var H=this,I=new Image;this.hov.addClass("loading");I.className="zoomed";I.onload=function(){I.onload=null;H.hov.hasClass("loading")&&(F.height(A.height()).append(I).show(),H.imgAnim(I),H.preLoad())};I.src=this.lnk.href},imgAnim:function(I){var M=this,L=G(I),K=this.imgPos(I.width||+L.attr("width"),I.height||+L.attr("height")),H=K[0]<K[6],J=this.evtMon(L,K[0],K[0]-K[6],!H);L.after(this.cap.hide()).css({left:K[4],top:K[5],width:K[2],height:K[3]}).animate({left:K[10],top:K[11]},this.opt.animDurA,function(){L.animate({left:K[8],top:K[9],width:K[6],height:K[7]},M.opt.animDurB,function(){M.hov.removeClass("loading");M.cap.css({top:K[7]+K[9],left:H?0:K[8],width:H?K[0]:K[6]}).fadeTo(300,0.7);M.nav.bind(J).css("top",K[7]/3+K[9]);M.keyBind()}).bind(J)})},imgQuit:function(H){this.hov.hide().hasClass("loading")?this.hov.removeClass("loading"):A.unbind(".phzoom");H&&D.fadeOut();F.hide().empty();return false},imgChange:function(H){this.imgQuit();G(".ph_hover",G(this.all[this.idx+H]).click()).show();return false},preLoad:function(H,I){this.idx&&(H=new Image,H.src=this.all[this.idx-1].href,delete H);this.end&&(I=new Image,I.src=this.all[this.idx+1].href,delete I)},keyBind:function(){var H=this;A.bind("keydown.phzoom",function(I){I=I.which;return I==37&&H.idx?H.imgChange(-1):I==39&&H.end?H.imgChange(1):I^27||H.imgQuit(1)})},evtMon:function(M,L,H,I){var J=this,K=G("span",this.nav).hide();return{click:function(N){return J.len<2||(N=N.pageX>L/2,J.idx?J.end?J.imgChange(N||-1):N||J.imgChange(-1):!N||J.imgChange(1))},mouseout:function(){K.hide()},mousemove:function(N,O){N=N.pageX,O=N>L/2;J.idx?(K.eq(O).show(),K.eq(1-O).hide()):K[O?"show":"hide"]();I||(N=N<L/3?0:N>L*2/3?H:H/2)==M.position().left||M.not(":animated").animate({left:N},200)}}}};G.phzoom=function(I,H,J){H=G.extend({layOpacity:0.7,layDur:300,animDurA:300,animDurB:300,navColor:"#cf0",capColor:"#cf0",prevText:"Prev",nextText:"Next",limitWidth:false,returnOrigin:true},H),(J=I.has("img"))[0]&&(G("#ph_lay")[0]||G("body").append(B),J.each(function(L,K){G.data(K,"phzoom",new C(G(K),H,L,J))}));return H.returnOrigin?I:J};G.fn.phzoom=function(H){return G.phzoom(this,H)}}(jQuery);